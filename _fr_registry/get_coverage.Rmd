---
title: "Get coverage for diphtheria"
---

```{r}
library(dplyr)
library(purrr)
library(magrittr)
library(tidyr)
library(ggplot2)
library(arrow)
library(lubridate)
options(arrow.unsafe_metadata = TRUE)
```

## Load data

```{r}
# get births by birth year per province
# this will be the denominator
birth_by_reg <- readRDS("../compiled_data/data/births_by_reg_address.rds") %>% 
  as_arrow_table()
birth_by_perma <- readRDS("../compiled_data/data/births_by_perma_address.rds") %>% 
  as_arrow_table()

# get shot by pathogen data, filter pathogen = "dip" only
pathogen_data <- open_dataset("/cluster_data/vrdata/cleaned/pathogen") %>% 
  filter(pathogen == "dip") %>% 
  compute()

# get pid to addresses mapping
pid_address_map <- read_parquet("../compiled_data/data/pid_birthplace_map.parquet",
                                as_data_frame = FALSE)

# get personal info for dob
personal_info <- read_parquet("/cluster_data/vrdata/cleaned/personal_info.parquet",
                              as_data_frame = FALSE)
```

## Computation

Compute coverage

-   For age group \[0-5), starting from 2019-2023

    -   we would want vaccination records from 2014-2023

-   At province level

-   Target first 3 shots: (scheduled for months 2-4-6 respectively)

```{r}
evaluated_years <- 2019:2023
# schedule for each dosage of diphtheria
# use the conservative schedule of 2-4-6 which is said to provide >95% protection
# https://vnvc.vn/vac-xin-bach-hau-co-trong-tiem-chung-mo-rong-khong/
# https://vnvc.vn/vac-xin-bach-hau-tiem-khi-nao/
dose_schedule <- c(2,4,6)
```

### Number of births (the denominator)

First get birth count at province level

```{r}
# concatenate births by registered address
birth_by_reg_concat <- birth_by_reg %>% 
  group_by(year, province_reg) %>% 
  summarize(
    no_births = sum(no_births)
  ) %>% 
  compute()

# concatenate births by permanent address
birth_by_perma_concat <- birth_by_perma %>% 
  group_by(year, province) %>% 
  summarize(
    no_births = sum(no_births)
  ) %>% 
  compute()

# convert to tibble after computing
birth_by_reg_concat <- birth_by_reg_concat %>% 
  collect() 

birth_by_perma_concat <- birth_by_perma_concat %>% 
  collect() 
```

Then compute the denominator for age range \[0 - 5\]

```{r}
# number of children within 0-5 per evaluated year by registered address
n_children_by_reg <- birth_by_reg_concat %>% 
  crossing(curr_eval_year = evaluated_years) %>% 
  mutate(
    # only keep children that are within the age range of interest
    within_5 = (curr_eval_year - year)<=5 & (curr_eval_year - year)>=0
  ) %>% 
  filter(within_5) %>% 
  # now compute total children within the age range of interest
  group_by(curr_eval_year, province_reg) %>% 
  summarize(
    n_children = sum(no_births)
  ) %>% 
  arrange(province_reg, curr_eval_year) %>% 
  rename()

# number of children within 0-5 per evaluated year by registered address
n_children_by_perma <- birth_by_perma_concat %>% 
  crossing(curr_eval_year = evaluated_years) %>% 
  mutate(
    # only keep children that are within the age range of interest
    within_5 = (curr_eval_year - year)<=5 & (curr_eval_year - year)>=0
  ) %>% 
  filter(within_5) %>% 
  # now compute total children within the age range of interest
  group_by(curr_eval_year, province) %>% 
  summarize(
    n_children = sum(no_births)
  ) %>% 
  arrange(province, curr_eval_year)
```

```{r}
# save intermediate result
# saveRDS(n_children_by_perma, "inter_data/n_children_by_perma.rds")
# saveRDS(n_children_by_reg, "inter_data/n_children_by_reg.rds")
```

Load cached data if necessary

```{r}
# n_children_by_perma <- readRDS("inter_data/n_children_by_perma.rds")
# n_children_by_reg <- readRDS("inter_data/n_children_by_reg.rds")
```

### Vaccination count (the numerator)

Include both

-   On schedule vaccination

-   Vaccination at any time

```{r}
pathogen_data <- pathogen_data %>% 
  select(pid, vacdate) %>% 
  group_by(pid) %>% 
  arrange(vacdate) %>%
  collect()

dip_3doses <- pathogen_data %>% 
  group_by(pid) %>% 
  slice(1:3) %>% 
  mutate(
    dose = 1:n()
  )
```

```{r}
# save intermediate data
# write_parquet(dip_3doses, "./inter_data/pid_first_3vacc.parquet")

dip_3doses <- read_parquet("./inter_data/pid_first_3vacc.parquet", as_data_frame=FALSE)
```

Get dob and label whether the vaccination is within schedule

-   3 doses scheduled for months 2-4-6 respectively

```{r}
dip_3doses <- dip_3doses %>% 
  as_arrow_table() %>% # again convert to arrow table for faster computation
  left_join(
    personal_info %>% select(pid, dob),
    by = join_by(pid == pid)
  ) %>% 
  mutate(
    schedule = case_when(
      dose == 1 ~ 2,
      dose == 2 ~ 4,
      dose == 3 ~ 6,
      .default = 18
    ),
    # latest date for vaccination 
    months_since_birth = arrow_days_between(dob, vacdate)/31,
    on_schedule = months_since_birth <= schedule
  ) %>% 
  filter(
    # keep records where vaccination are within 0-5 at time of vaccination to reduce data size
    arrow_days_between(dob, vacdate)/365.25 <= 5
  ) %>% 
  compute()
```

Now that we got a slightly smaller dataset, we now compute the number of vaccination by the end of each year from 2019-2024

```{r}
# =========== Vaccount by registered/residential address =========  
# compute the total number of vaccination at each evaluation time 
vaccinated_by_reg <- map(evaluated_years, \(curr_year){
  # Step 1: Get vaccination records for the children within 0-5 year at curr_year of evaluation
  dip_3doses %>% 
    filter(
      # only keep records up until (the end) of the current year of vaccination
      year(vacdate) <= curr_year,
      # only keep records for children from 0-5 years old at the curr_year
      (curr_year - year(dob)) <= 5
    ) %>% 
  # Step 2: Summarize by pid to count the number of vaccination each child received at curr_year
    group_by(pid) %>% 
    summarize(
      # total doses (max 3) is the number of vaccination records
      total_doses = n(),
      total_doses_on_schedule = sum(on_schedule)
    ) %>% 
    # Get the registered address of each pid
    left_join(pid_address_map %>% select(pid, dob, province_reg) , by = join_by(pid == pid)) %>% 
  # Step 3: Count the number of children by province_reg that received specific lvl of vaccination
    group_by(province_reg) %>% 
    summarize(
      # number of children vaccinated at least 1 dose
      dose1 = sum(total_doses>=1),
      # number of children vaccinated at least 2 doses
      dose2 = sum(total_doses>=2),
      # number of children vaccinated 3 doses
      dose3 = sum(total_doses==3),
      # number of children vaccinated at least 1 dose on schedule
      dose1_on_schedule = sum(total_doses_on_schedule>=1),
      # number of children vaccinated at least 2 doses on schedule
      dose2_on_schedule = sum(total_doses_on_schedule>=2),
      # number of children vaccinated 3 doses on schedule
      dose3_on_schedule = sum(total_doses_on_schedule==3),
    ) %>% collect() %>% 
    mutate(
      evaluated_year = curr_year
    )
})

# =========== Vaccount by permanent address =========  
# compute the total number of vaccination at each evaluation time 
vaccinated_by_perma <- map(evaluated_years, \(curr_year){
  # Step 1: Get vaccination records for the children within 0-5 year at the current year of evaluation
  dip_3doses %>% 
    filter(
      # only keep records up until (the end) of the current year of vaccination
      year(vacdate) <= curr_year,
      # only keep records for children from 0-5 years old at the curr_year
      (curr_year - year(dob)) <= 5
    ) %>% 
  # Step 2: summarize by pid to count the number of vaccination each child received at curr_year
    group_by(pid) %>% 
    summarize(
      # total doses (max 3) is the number of vaccination records
      total_doses = n(),
      total_doses_on_schedule = sum(on_schedule)
    ) %>% 
    # Get the registered address of each pid
    left_join(pid_address_map %>% select(pid, dob, province) , by = join_by(pid == pid)) %>% 
    # Now compute the number of vaccinated children at specific levels of dosage at curr_year
  # Step 3: Count the number of children by province that received specific lvl of vaccination
    group_by(province) %>% 
    summarize(
      # number of children vaccinated at least 1 dose
      dose1 = sum(total_doses>=1),
      # number of children vaccinated at least 2 doses
      dose2 = sum(total_doses>=2),
      # number of children vaccinated 3 doses
      dose3 = sum(total_doses==3),
      # number of children vaccinated at least 1 dose on schedule
      dose1_on_schedule = sum(total_doses_on_schedule>=1),
      # number of children vaccinated at least 2 doses on schedule
      dose2_on_schedule = sum(total_doses_on_schedule>=2),
      # number of children vaccinated 3 doses on schedule
      dose3_on_schedule = sum(total_doses_on_schedule==3),
    ) %>% collect() %>% 
    mutate(
      evaluated_year = curr_year
    )
})
```

### Coverage

Finally compute the coverage by each type of addresses

```{r}
# ====== Coverage by residential address =======
coverage_by_reg <- n_children_by_reg %>% 
  # get the number of births (the denominator for the coverage)
  left_join(
    vaccinated_by_reg %>% 
      bind_rows() %>% 
      arrange(province_reg, evaluated_year),
    by = join_by(curr_eval_year == evaluated_year, province_reg == province_reg)
  ) %>% 
  # compute the coverage 
  mutate(
    dose_1_cov = dose1/n_children,
    dose_2_cov = dose2/n_children,
    dose_3_cov = dose3/n_children,
    dose_1_on_schedule_cov = dose1_on_schedule/n_children,
    dose_2_on_schedule_cov = dose2_on_schedule/n_children,
    dose_3_on_schedule_cov = dose3_on_schedule/n_children
  ) 

# ====== Coverage by permanent address =======
coverage_by_perma <- n_children_by_perma %>% 
  left_join(
    vaccinated_by_perma %>% 
      bind_rows() %>% 
      arrange(province, evaluated_year),
    by = join_by(curr_eval_year == evaluated_year, province == province)
  ) %>% 
  mutate(
    dose_1_cov = dose1/n_children,
    dose_2_cov = dose2/n_children,
    dose_3_cov = dose3/n_children,
    dose_1_on_schedule_cov = dose1_on_schedule/n_children,
    dose_2_on_schedule_cov = dose2_on_schedule/n_children,
    dose_3_on_schedule_cov = dose3_on_schedule/n_children
  )

coverage_by_perma <- coverage_by_perma %>% filter(
  province != "Tỉnh tập huấn"
)
```

## Simple plotting

```{r}
coverage_by_reg %>% 
  select(province_reg, curr_eval_year, dose_1_cov, dose_2_cov, dose_3_cov) %>% 
  pivot_longer(
    cols = c("dose_1_cov", "dose_2_cov", "dose_3_cov"),
    names_to = "dose",
    values_to = "coverage"
  ) %>% 
  ggplot() +
    geom_line(aes(x = curr_eval_year, y = coverage, color = dose)) +
    facet_wrap(~province_reg)
```

```{r}
coverage_by_perma %>% 
  select(province, curr_eval_year, dose_1_cov, dose_2_cov, dose_3_cov) %>% 
  pivot_longer(
    cols = c("dose_1_cov", "dose_2_cov", "dose_3_cov"),
    names_to = "dose",
    values_to = "coverage"
  ) %>% 
  ggplot() +
    geom_line(aes(x = curr_eval_year, y = coverage, color = dose)) +
    facet_wrap(~province)
```

## Save data

```{r}
saveRDS(coverage_by_reg, "data/dip_coverage_by_reg.rds")
saveRDS(coverage_by_perma, "data/dip_coverage_by_perma.rds")
```
