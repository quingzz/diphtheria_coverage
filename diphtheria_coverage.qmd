---
title: "Coverage of diphtheria"
format: 
  html: 
    df-print: paged
    embed-resources: true
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(downloadthis)
```

```{r echo=FALSE}
# preprocess data
cov_by_perma <- readRDS("data/dip_coverage_by_perma.rds")
cov_by_reg <- readRDS("data/dip_coverage_by_reg.rds")

cov_by_perma <- cov_by_perma %>% mutate(
  province = case_when(
    province == "Thành phố Hồ Chí Minh" ~ "Hồ Chí Minh",
    province == "Hòa Bình" ~ "Hoà Bình",
    .default = province
  )
)

cov_by_reg <- cov_by_reg %>% mutate(
  province_reg = case_when(
    province_reg == "Thành phố Hồ Chí Minh" ~ "Hồ Chí Minh",
    province_reg == "Hòa Bình" ~ "Hoà Bình",
    .default = province_reg
  )
)

write_csv(cov_by_perma, "data/dip_coverage_by_perma.csv")
write_csv(cov_by_reg, "data/dip_coverage_by_reg.csv")
```

## Coverage data

Diphtheria vaccination coverage data for children aged 0--5 years

The data is separated into 2 files:

-   `dip_coverage_by_perma.csv`: coverage data where each child's location is determined by their **permanent address** (i.e., the address listed on official documents)

-   `dip_coverage_by_reg.csv`: coverage data where each child's location is based on the address where they **registered for their first vaccination**, typically their residential address.

```{r}
# load data
cov_by_perma <- read.csv("data/dip_coverage_by_perma.csv")
cov_by_reg <- read.csv("data/dip_coverage_by_reg.csv")
```

### Data dictionary

```{=html}
<details>
  <summary>
    List of variables
  </summary>
```
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| Variable                  | Description                                                                                                                        |
+===========================+====================================================================================================================================+
| `curr_eval_year`          | Year of evaluation (i.e. the year for which coverage is computed)                                                                  |
|                           |                                                                                                                                    |
|                           | \                                                                                                                                  |
|                           | For example: when `curr_eval_year=2019` coverage is computed for children born between 2014-2019                                   |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `province`/`province_reg` | Province of residence, based on either the permanent address (`province`) or the registered vaccination address (`province_reg`).\ |
|                           | \                                                                                                                                  |
|                           | Note that we don't have data where `province_reg == "Bình Định"`                                                                   |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `n_children`              | Number of children aged 0-5                                                                                                        |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose1`                   | Number of children aged 0-5 who received at least 1 dose of vaccination                                                            |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose2`                   | Number of children aged 0-5 who received at least 2 dose of vaccination                                                            |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose3`                   | Number of children aged 0-5 who received at least 3 dose of vaccination                                                            |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose1_on_schedule`       | Number of children aged 0-5 who received at least 1 dose on schedule                                                               |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose2_on_schedule`       | Number of children aged 0-5 who received at least 2 dose on schedule                                                               |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose3_on_schedule`       | Number of children aged 0-5 who received at least 3 dose on schedule                                                               |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose_1_cov`              | Coverage for 1 dose `dose1/n_children`                                                                                             |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose_2_cov`              | Coverage for 2 dose `dose2/n_children`                                                                                             |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose_3_cov`              | Coverage for 3 dose `dose3/n_children`                                                                                             |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose_1_on_schedule`      | Coverage for 1 dose on schedule `dose1_on_schedule/n_children`                                                                     |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose_2_on_schedule`      | Coverage for 2 dose on schedule `dose2_on_schedule/n_children`                                                                     |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+
| `dose_3_on_schedule`      | Coverage for 3 dose on schedule `dose3_on_schedule/n_children`                                                                     |
+---------------------------+------------------------------------------------------------------------------------------------------------------------------------+

**Note:** I found 2 diphtheria vaccination schedules for newborns: either at `2-3-4` months old or `2-4-6` months old so I used the latter to be more inclusive.

</details>

### Download data

*Click the button below to download* `dip_coverage_by_perma.csv`

```{r, echo=FALSE}
download_this(
  cov_by_perma,
  button_label = "Download diphtheria coverage by permanent address",
  output_name = "dip_coverage_by_perma",
  output_extension = ".csv",
  button_type = "primary",
  has_icon = TRUE,
  icon = "fa fa-save"
)
```

*Click the button below to download* `dip_coverage_by_reg.csv`

```{r, echo=FALSE}
download_this(
  cov_by_reg,
  button_label = "Download diphtheria coverage by residential address",
  output_name = "dip_coverage_by_reg",
  output_extension = ".csv",
  button_type = "primary",
  has_icon = TRUE,
  icon = "fa fa-save"
)
```

### Data table

::: panel-tabset
## By residential address

```{r}
cov_by_reg
```

## By permanent address

```{r}
cov_by_perma
```
:::

## Visualization

### Geo map

```{ojs}
//| output: false
//| echo: false

vn = FileAttachment("data/gadm41_VNM_1_2.json").json()
vn_province = topojson.feature(vn, vn.objects.gadm41_VNM_1)

coverage_data_residential = FileAttachment("data/dip_coverage_by_reg.csv").csv({typed: true})
coverage_data_perma = FileAttachment("data/dip_coverage_by_perma.csv").csv({typed: true})
// pathogen_province_select = coverage_data_province.filter(d => (d.pathogen === pathogenSelect))
// pathogen_all_select = coverage_data_all.filter(d => (d.pathogen === pathogenSelect) & (d.yob > 2014 && d.yob < 2022))
// pathogen_all_select_all = pathogen_all_select.filter(d => (d.vacage_group === "all"))
// pathogen_all_select_oneyear = pathogen_all_select.filter(d => (d.vacage_group === "(0-1y]"))
Plot = import("https://cdn.jsdelivr.net/npm/@observablehq/plot/+esm")

import {addTooltips} from "@mkfreeman/plot-tooltip"
percent = d3.format(".2%")
```

```{ojs}
//| echo: false

// select year of evalutation
viewof yearSelect = Inputs.range([2019, 2023], 
                                 {label: "Year:", step: 1, value: 2019})
                                 
viewof address_type = Inputs.select(["permanent", "residential"], 
                                {label: "Type of address:"})          
                             
viewof dose_select = Inputs.select(["≥1 dose", "≥2 doses", "≥3 doses"], 
                      {label: "Vaccination dose:"}) 

viewof coverage_type = Inputs.select(["all", "on schedule"], {label: "Type of coverage:"})    
```

```{ojs}
//| echo: false
coverage_data = (address_type == "permanent") ? coverage_data_perma : coverage_data_residential

dose_select_mapping = new Map([
  ["≥1 dose", "dose_1"],
  ["≥2 doses", "dose_2"],
  ["≥3 doses", "dose_3"]
])

coverage_type_mapping = new Map([
  ["all", "_cov"],
  ["on schedule", "_on_schedule_cov"],
])

coverage_data_filter = coverage_data.filter(d => (d.curr_eval_year === yearSelect))

province_coverage_map = new Map(
  coverage_data_filter.map(
    (row => {
      const province = address_type === "permanent" ? row.province : row.province_reg;

      // select coverage column based on input
      const coverage = row[
                        dose_select_mapping.get(dose_select) + 
                        coverage_type_mapping.get(coverage_type)
                        ]
  
      return [province, coverage];
    })
  )  
)
```

```{ojs}
//| echo: false
addTooltips( // Add tooltips
Plot.plot({
  //marginRight: 100,
  //marginLeft: 100,
  //marginTop: 0,
  //marginBottom: 0,
  height:600,
  projection: { type: "mercator", domain: vn_province},
  marks: [
    Plot.geo(vn_province, {
      fill: (d) => province_coverage_map.get(d.id),
      title: (d) => `${d.id} \n ${percent(province_coverage_map.get(d.id))}`
      }),
    Plot.geo(vn_province, {stroke: "#fff", strokeWidth: 0.5})
  ],
  color: {
    scheme: "spectral", // Change color scheme
    unknown: "#ddd", // Polygons with unknown broadband values are gray
    type: "linear", // Linear scale for color progression
    legend: true, // Add the legend
    label: "% of vaccine coverage", // Update legend label
    percent: true, // Convert value to a percent (from a proportion)
    domain: [0, 100] // Update the value domain to span 0 to 100% access
  }
})
)
```

### Coverage by province

```{ojs}
//| echo: false

// Configurations for the line plot
viewof province_select = Inputs.select(province_coverage_map.keys(), 
                      {label: "Select province:"}) 
                      
viewof address_type2 = Inputs.select(["permanent", "residential"], 
                      {label: "Type of address:"})   
```

```{ojs}
//| echo: false
coverage_data2 = (address_type2 == "permanent") ? coverage_data_perma : coverage_data_residential

coverage_for_selected = coverage_data2.filter(d => (
    (address_type2 == "permanent") ? 
    d.province === province_select : 
    d.province_reg === province_select
  ))
  
// coverage_for_selected

addTooltips( // Add tooltips
Plot.plot({
  title: "Diphtheria coverage for " + province_select,
  x: {
    label: "Year"
  },
  y: {
    label: "Vaccine coverage (%)",
    domain: [0, 100],
    percent: true,
    grid: true,
    tickFormat: d => d + "%"
  },
  marks: [
    Plot.ruleY([0]),
    Plot.line(coverage_for_selected, {x: "curr_eval_year", y: "dose_1_cov", stroke: "red", 
                  title: (d) => `≥1 dose`}),
    Plot.line(coverage_for_selected, {x: "curr_eval_year", y: "dose_2_cov", stroke: "blue", 
                  title: (d) => `≥2 dose`}),
    Plot.line(coverage_for_selected, {x: "curr_eval_year", y: "dose_3_cov", stroke: "purple", 
                  title: (d) => `≥3 dose`}),
    Plot.line(coverage_for_selected, {x: "curr_eval_year", y: "dose_1_on_schedule_cov", 
    stroke: "red", strokeDasharray: [5, 5], title: (d) => `≥1 dose on schedule`}),
    Plot.line(coverage_for_selected, {x: "curr_eval_year", y: "dose_2_on_schedule_cov", 
    stroke: "blue", strokeDasharray: [5, 5], title: (d) => `≥2 dose on schedule`}),
    Plot.line(coverage_for_selected, {x: "curr_eval_year", y: "dose_3_on_schedule_cov", 
    stroke: "purple",  strokeDasharray: [5, 5], title: (d) => `≥3 dose on schedule`}),
  ]
})
)
```
